"""
Hash table implementation for caching line solver results.
Corresponds to Hash.h and Hash.cpp in the C++ version.
"""

from typing import Dict, Tuple, Optional
from bit import LineMask
from puzzle import LineNumbers

# Hash table size
HTABLE_SIZE = 9999991


class HashNode:
    """Represents a single entry in the hash table."""
    
    def __init__(self):
        self.line_problem: Optional[LineNumbers] = None
        self.now_string: LineMask = 0
        self.settle_string: LineMask = 0


# Global hash table
hash_table: Dict[int, HashNode] = {}


def initial_hash() -> None:
    """
    Initialize the hash table and Zobrist hash key table.
    Called once at program start.
    """
    global hash_table
    hash_table = {}
    # z_hash_key_table is already initialized as a constant below


def insert_hash(problem: LineNumbers, now_string: LineMask, settle_string: LineMask) -> None:
    """
    Insert a line solver result into the hash table.
    
    Args:
        problem: The line clues
        now_string: Current state of the line
        settle_string: Solved state of the line
    """
    key = (problem.hash_key ^ now_string) % HTABLE_SIZE
    
    node = HashNode()
    # Copy the line problem data
    node.line_problem = LineNumbers()
    node.line_problem.m_count = problem.m_count
    node.line_problem.m_numbers = problem.m_numbers.copy()
    node.line_problem.m_sum = problem.m_sum.copy()
    node.line_problem.hash_key = problem.hash_key
    
    node.now_string = now_string
    node.settle_string = settle_string
    
    hash_table[key] = node


def find_hash(problem: LineNumbers, now_string: LineMask) -> Tuple[bool, LineMask]:
    """
    Look up a line solver result in the hash table.
    
    Args:
        problem: The line clues
        now_string: Current state of the line
    
    Returns:
        Tuple of (found, settle_string) where found is True if cached result exists
    """
    key = (problem.hash_key ^ now_string) % HTABLE_SIZE
    
    if key not in hash_table:
        return False, 0
    
    node = hash_table[key]
    
    # Check if this is the same problem
    if node.now_string != now_string:
        return False, 0
    
    if node.line_problem is None:
        return False, 0
    
    # Compare the line problems
    if (node.line_problem.m_count != problem.m_count or
        node.line_problem.hash_key != problem.hash_key):
        return False, 0
    
    # Additional check: compare the actual numbers
    for i in range(problem.m_count + 1):
        if node.line_problem.m_numbers[i] != problem.m_numbers[i]:
            return False, 0
    
    return True, node.settle_string


# Zobrist hash key table
# This is a pre-computed random table for hash key generation
# Dimensions: [13][26] for up to 13 blocks and max block size of 25
z_hash_key_table = [
    [759055707854222535, 11872126079661544008, 10666341186357044533, 14271371299812038426, 12410598966417316021, 4133490037383340789, 1506965450440365256, 16303698503260591679, 18194211981394086425, 10856133602674542089, 17959415083258366339, 16996574565479338429, 15278974144939869952, 1178904170415774107, 14312159022178454285, 999233085284360399, 3673610032419565815, 10200191378812961596, 17171052572236990857, 12910624415628975563, 1133753269132240824, 16861286648502985131, 7683044039126900139, 1038922509328365637, 1936665759235952618, 11523903229869633698],
    [4443749714730530452, 4931317069979750352, 2878540801725610348, 6814224272552736412, 8602295802373299017, 817450930937265345, 9729088585069824092, 1826869469444344908, 1832792314769568220, 970911533329418781, 12993319895482997274, 1551611976840078566, 1013083528060652185, 11881704730350700540, 2497447311264289494, 5959612926913526374, 6601168014724182827, 18049490391873106099, 16958398057790791008, 1861772138104693913, 16725831962028968827, 11789023541005436750, 2721076887055001735, 963046728587824132, 16199949645786162680, 2585183267861616188],
    [13442899657103353846, 12670323325790699708, 17966831504026015193, 5511002498937852408, 11553356999201370163, 654272881313039396, 4066899801665341059, 17633713127922013165, 295219453981572467, 5306565072318765506, 194862032116562003, 13120655311599088812, 10027809420366029844, 13164134982359992265, 437395564559695689, 608492045632161667, 1065720999459082908, 18169099198871230912, 18228051325149066345, 16420075374420790763, 2627401864689641493, 16686033356496670341, 18195765945304522206, 1990826001870075319, 15135534246272736394, 7678572270892754578],
    [4915743881155120569, 15382883110411687878, 3208677860630303494, 11405585426356392905, 3619901911520068310, 15269347395525958321, 463795585935020365, 323309407431096893, 6082498896797955114, 12578189921767449685, 144618453037943293, 2904226964170863550, 8814165841413682661, 18067942192200254332, 6088178713650187452, 8470443469612998403, 6987495215267895321, 2450359492416774122, 14111932932835372533, 15134639079445810532, 16980697896597851825, 2046088857491236261, 8853652317125007037, 1684638287021652454, 11956247818384589303, 7340815900818344323],
    [9557290848543934204, 13828575586659117249, 10928748662034900827, 16184465235541545515, 6266687536136366919, 5426530894847719965, 13152571260121756810, 12246161496811710261, 6517649567867222143, 580863084621801998, 1312891544210097081, 10966547441209111942, 13381938837246665789, 8340957950309812544, 3581451898302779457, 9368000394858849431, 7308611851001495041, 8851113127088745940, 14276240113269008173, 490372281913590383, 9648211762357338737, 4209174509902788828, 12539896776181909577, 321131893796685793, 17930851537743227476, 11047484489807182366],
    [9769561457821568427, 1878109877624363053, 8180335534929972581, 1685787582733398475, 8823408379554291918, 2452913461454803949, 3285386951354218491, 15958363242992130620, 5070203837403381359, 8592996729534694203, 2144532492139557833, 8595151320355916694, 4111633073542417775, 16073167516644684090, 14921232872118691769, 18248584862374279404, 5854918362689955315, 5605473696763084716, 4634058286818340089, 15824751583198232594, 7927379532644322117, 3287564947286754174, 11633191972662077398, 2675743407400600703, 17342098741278977254, 202627089158275],
    [13508947998995935195, 13154969062426010308, 4675279879065952604, 14296610569370528522, 6700660643361765415, 2263586256334647694, 11395805082994282493, 14245903139927190272, 4999094848529893121, 12837979104350841162, 15025661522744951970, 4981677662198792478, 11253247627290602958, 16064711114660469251, 16895494418771937184, 15786488244016388961, 5685786843405589761, 10443628438009104823, 3335168574974731943, 16535407458984689505, 11271530839338165296, 12268383679988814307, 12970492223527198255, 10499682768902668294, 10483433845573723716, 16396574714988451087],
    [13182362026222521242, 10032961072849472479, 9328652478331979952, 6904564497726339991, 1613365524275766750, 7704640374587669602, 5254203494666399497, 12032763313590280360, 17992726605871965135, 15904062185373752637, 7991895495104294893, 532502632217709643, 3557593412280107643, 8270241588379152983, 4515372992892596030, 9223387754394478480, 1286821572756027341, 17869158897008401026, 1320080521141852072, 7884100809049428143, 521446125401890978, 8299456104643022943, 9246745133015735911, 4121222301738119830, 6570152222751434703, 4109886099917632561],
    [10870644326992282004, 1711220661820073572, 17152761295905024888, 12732480991574778562, 1224578080386395683, 15821794734242708184, 16651366523420711966, 1479432057303499100, 17980379651286941408, 2522732881074773570, 13480939973557008780, 6843581593579176755, 6404193038964845569, 12490053480717040445, 11506696836100190992, 7191489355786214932, 3237743410922730555, 13709708166701044880, 8336143641159887817, 1844638314023533118, 5030622918803098121, 4596012735048625614, 3064393198265160488, 5686302705909871166, 5273025062446376010, 5399063242685992491],
    [5638311152600174187, 7385617043925203729, 10858814461594053459, 14589212647143699987, 8233862686256390624, 15472868268300238518, 17829916968657935831, 10885558505415069530, 15328201003703044614, 360139693485680009, 10131261970687357965, 12401861429396637775, 10958162750119692103, 2708819993706501659, 6349135367714372050, 7005496928653674374, 408700268364345494, 5077576672506162206, 14281328195458555598, 17614776488785973778, 14416841214793128816, 2466571110623060883, 3451062369842172441, 14174139286819753846, 4450513341500658814, 285728340274758352],
    [10747174989735955340, 987682892211036935, 9408748426967521851, 12142967263543804484, 3487091897510377924, 9365701871589527998, 17719510923323962860, 13684805804189267786, 4094997952697375273, 16303171118951950146, 1211971996311999564, 13191394118655126410, 995900035437721588, 10853805865166160454, 830967248388575377, 4226178061931002011, 8849380136075219555, 13981695347778254365, 8162625784110670648, 944011483278227013, 15196227996662312539, 5439272479112023182, 5450707187613430901, 10306847319664130615, 923524439044208780, 18361397752759412508],
    [16030522045324185611, 13044001502870626970, 10304705347122336651, 11366665748778469063, 270607423185149007, 6283695468543643716, 2593406968247605502, 2894380828442048113, 10559171723374841363, 2843496428437549758, 9676842070921619162, 12680824187606258784, 10675984168617482400, 6652094990952263183, 14643613270400594524, 18193376564351555978, 13613681308114392031, 15019459475987182009, 9063694019978219093, 8472383287289689189, 1311126057867428888, 16810822765404951, 10924686673993639495, 23203051017681695, 6221757625398127912, 987455274408642379],
    [5331283757361879929, 10674776361076413657, 12714393299481653788, 16346556483683607778, 6225857208318419701, 3369707588546496327, 9470970152979268086, 13606139778906282085, 12335969611361244351, 16061657441760267693, 4373274543781128153, 9347857330272536820, 13444086705852441758, 14759959153837885923, 15294360714516542464, 13111196743008244047, 16483571698429709984, 11926923570193092792, 14391820130289261433, 6862630208141547385, 6359267128607907145, 3831464488789114341, 7236403821834207107, 18313502017041794723, 16093261437324577464, 3463888029380893773],
]
